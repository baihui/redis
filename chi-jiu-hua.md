
  $$ 持久化有两种方式，一种是快照数据RDB，另外一种是记录写命令AOF$$
 
--- 
 
#### RDB

**RDB持久化属于快照备份每次创建新文件** 既可以手动执行，也可以根据服务器配置save选项定期执行，数据库状态**key-value** 保存到一个经过压缩的二进制RDB文件中 通过该文件可以还原生成RDB文件时的数据库状态。

* ##### 手动（save和bgsave命令）
   * save
      $$save命令会阻塞Redis服务器进程，直到RDB文件创建完毕为止，在服务器进程 阻塞期间， 服务器不能处理任何命令请求：$$
      
      ``` 
      save 
      
      ```
   * bgsave
      $$ bgsave命令会不阻塞Redis服务器进程，而是派生出另外线程进行持久化：$$
     
      ``` 
      bgsave 
      
      ```

   
* ##### 自动（[配置文件save参数](/redispei-zhi-wen-jian.md) 执行的命令是bgsave）
   
   save 900 1 
   save 300 10 
   save 60 10000
 
   只要满足以上三个条件中的任意一个，BGSAVE命令就会被执行
 
> RDB文件的载入是在服务器启动时自动执行的， 并没有专门用于载入RDB文件的命令， 只要Redis服务器在启动时检测到RDB文件存在， 它就会自动载入RDB文件。
![](/assets/屏幕快照 2018-09-06 上午7.22.53.png)
 

* ##### 关闭RDB备份

   将配置文件中关于save配置信息全部注释，如下：

   ```
   save ""
   ```
   重启Redis服务即可 或者执行操作命令
   
   ```
   
   CONFIG SET save ""
   
   ```
   执行命令后，无需重启服务，即可生效。
   
> 如果开启[主存同步](/fu-zhi.md)，关闭save 无效，服务器自动开启

 
#### AOF

* AOF持久化是通过保存服务器所执行的写命令来记录数据库状态的。
   ![](/assets/屏幕快照 2018-09-06 上午7.49.48.png)

* AOF持久化功能的实现分为三个步骤
   
   1 追加 - 被执行的写命令追加到服务器aof_buf缓冲区的末尾。
   2 文件写入(写入操作系统缓冲区)
   3 文件同步（写入硬盘）
   
   > 现代操作系统将一些数据写入到文件的时候， 操作系统通常会将写入数据 暂时保存在一个内存缓冲区里面， 等到缓冲区的空间被填满、 或者超过了 指定的时限之后在进行文件同步。


   
   
* flushAppendOnlyFile 函数负责将aof_buf缓冲区中的内容写入和保存到AOF文件里面[服务器配置的appendfsync](/redispei-zhi-wen-jian.md)选项的值来决定，如下：
![](/assets/屏幕快照 2018-09-07 上午5.17.02.png)
   
   
   
* AOF持久化的效率和安全性

   * always 每个事件循环都要将aof_buf缓冲区中的所有内容写入到AOF文件，并且同步AOF文件。
   * everysec 每个事件循环都要将aof_buf缓冲区中的所有内容写入到AOF文件，并且每隔一秒就要在子线程中对AOF文件进行一次同步。
   * no 每个事件循环都要将aof_buf缓冲区中的所有内容写入到AOF文件，至于何时对AOF文件进行同步，则由操作系统控制
        
> always的效率是appendfsync选项三个值当中最慢的一个，但从安全性来说，always也是最安全的，因为即使出现故障停机，AOF持久化也只会丢失一个事件循环中所产生的命令数据。
everysec模式足够快，并且就算出现故障停机，数据库也只丢失一秒钟的命令数据.
no系统控制因为处于no模式下的flushAppendOnlyFile调用无须执行同步操作，所以该模式下的AOF文件 写入速度总是最快的，



 
 
 
 